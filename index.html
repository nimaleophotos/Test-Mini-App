<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Mini Camera App</title>
  <style>
    body, html { margin:0; padding:0; height:100%; background:black; overflow:hidden; font-family:sans-serif; }
    #camera { position:relative; width:100%; height:100%; }
    video { width:100%; height:100%; object-fit:cover; }
    .controls { position:absolute; bottom:20px; width:100%; display:flex; justify-content:center; gap:12px; z-index:10; }
    .controls button { padding:15px; border:none; border-radius:50%; background:rgba(255,255,255,0.2); color:white; font-size:16px; cursor:pointer; }
    .lens-switcher { position:absolute; bottom:100px; width:100%; display:flex; justify-content:center; gap:8px; z-index:10; }
    .lens-switcher button { padding:10px 14px; border:none; border-radius:12px; background:rgba(255,255,255,0.2); color:white; cursor:pointer; }
    .grid { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; 
      background-image: linear-gradient(rgba(255,255,255,.2) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(255,255,255,.2) 1px, transparent 1px);
      background-size: 33.3% 33.3%; display:none; z-index:5;
    }
  </style>
</head>
<body>
  <div id="camera">
    <video id="preview" autoplay playsinline muted></video>
    <div id="grid" class="grid"></div>

    <div class="lens-switcher" id="lensSwitcher"></div>

    <div class="controls">
      <button id="captureBtn">📸</button>
      <button id="switchBtn">🔄</button>
      <button id="flashBtn">⚡</button>
      <button id="gridBtn">#</button>
    </div>
  </div>
  <canvas id="snap" style="display:none;"></canvas>

  <script>
    let video = document.getElementById('preview');
    let canvas = document.getElementById('snap');
    let grid = document.getElementById('grid');
    let lensSwitcher = document.getElementById('lensSwitcher');

    let stream = null;
    let devices = [];
    let currentDeviceId = null;
    let torchOn = false;

    // 1️⃣ Enumerate cameras and populate lens buttons
    async function initCameras() {
      await navigator.mediaDevices.getUserMedia({ video: true }); // permission
      devices = (await navigator.mediaDevices.enumerateDevices()).filter(d => d.kind === 'videoinput');
      renderLensButtons();
      if (devices.length > 0) startStream(devices[0].deviceId);
    }

    function renderLensButtons() {
      lensSwitcher.innerHTML = '';
      devices.forEach((d, i) => {
        let btn = document.createElement('button');
        btn.innerText = i===0 ? "0.5x" : i===1 ? "1x" : i===2 ? "2x" : "Lens";
        btn.onclick = () => startStream(d.deviceId);
        lensSwitcher.appendChild(btn);
      });
    }

    // 2️⃣ Start camera stream
    async function startStream(deviceId) {
      if (stream) stream.getTracks().forEach(t => t.stop());
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId }, width:{ideal:1920}, height:{ideal:1080} } });
        video.srcObject = stream;
        currentDeviceId = deviceId;
      } catch(e) {
        console.error("Camera error:", e);
      }
    }

    // 3️⃣ Capture photo
    document.getElementById('captureBtn').onclick = () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      let ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      let dataUrl = canvas.toDataURL('image/jpeg');
      window.open(dataUrl, '_blank');
    };

    // 4️⃣ Switch front/back camera
    document.getElementById('switchBtn').onclick = () => {
      let front = devices.find(d=>d.label.toLowerCase().includes('front'));
      let back = devices.find(d=>d.label.toLowerCase().includes('back'));
      if (currentDeviceId === front?.deviceId && back) startStream(back.deviceId);
      else if (front) startStream(front.deviceId);
    };

    // 5️⃣ Flash toggle (torch)
    document.getElementById('flashBtn').onclick = async () => {
      if (!stream) return;
      let track = stream.getVideoTracks()[0];
      let caps = track.getCapabilities();
      if (caps.torch) {
        torchOn = !torchOn;
        await track.applyConstraints({ advanced:[{ torch: torchOn }] });
      } else {
        alert("Torch not supported on this device/browser");
      }
    };

    // 6️⃣ Grid toggle
    document.getElementById('gridBtn').onclick = () => {
      grid.style.display = grid.style.display === 'block' ? 'none' : 'block';
    };

    initCameras();
  </script>
</body>
</html>
