import React, { useState, useRef, useEffect } from "react";
import { Zap, ZapOff, RotateCcw } from "lucide-react";

export default function CameraApp() {
  const videoRef = useRef(null);
  const streamRef = useRef(null);

  const [devices, setDevices] = useState([]);
  const [selectedDeviceId, setSelectedDeviceId] = useState(null);
  const [flash, setFlash] = useState(false);

  // 🔍 Get all cameras (lenses)
  useEffect(() => {
    async function loadDevices() {
      try {
        const allDevices = await navigator.mediaDevices.enumerateDevices();
        const cams = allDevices.filter(d => d.kind === "videoinput");
        setDevices(cams);

        if (cams.length > 0) {
          startStream(cams[0].deviceId); // default = first back cam
        }
      } catch (err) {
        console.error("Error listing devices:", err);
      }
    }
    loadDevices();
  }, []);

  // 🎥 Start camera stream
  async function startStream(deviceId) {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
    }

    try {
      const constraints = {
        video: {
          deviceId: { exact: deviceId },
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        }
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      streamRef.current = stream;
      videoRef.current.srcObject = stream;
      setSelectedDeviceId(deviceId);
    } catch (err) {
      console.error("Error starting camera:", err);
    }
  }

  // 📸 Take photo
  function capturePhoto() {
    const canvas = document.createElement("canvas");
    const video = videoRef.current;
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL("image/jpeg");
    console.log("Captured photo:", dataUrl);
  }

  return (
    <div className="relative h-screen w-full bg-black overflow-hidden">
      {/* Camera preview */}
      <video
        ref={videoRef}
        autoPlay
        playsInline
        muted
        className="w-full h-full object-cover"
      />

      {/* Lens switcher */}
      <div className="absolute bottom-28 w-full flex justify-center gap-4">
        {devices.map((cam, i) => (
          <button
            key={cam.deviceId}
            onClick={() => startStream(cam.deviceId)}
            className={`px-4 py-2 rounded-full ${
              cam.deviceId === selectedDeviceId
                ? "bg-blue-500 text-white"
                : "bg-white/20 text-white"
            }`}
          >
            {i === 0 ? "0.5x" : i === 1 ? "1x" : i === 2 ? "2x" : "Lens"}
          </button>
        ))}
      </div>

      {/* Capture + Switch + Flash */}
      <div className="absolute bottom-8 w-full flex justify-center gap-6">
        <button
          onClick={capturePhoto}
          className="w-16 h-16 rounded-full bg-white"
        />
        <button
          onClick={() => {
            // Switch between front & back
            const front = devices.find(d => d.label.toLowerCase().includes("front"));
            const back = devices.find(d => d.label.toLowerCase().includes("back"));
            if (selectedDeviceId === front?.deviceId && back) {
              startStream(back.deviceId);
            } else if (front) {
              startStream(front.deviceId);
            }
          }}
          className="p-4 bg-white/20 text-white rounded-full"
        >
          <RotateCcw />
        </button>
        <button
          onClick={() => setFlash(f => !f)}
          className="p-4 bg-white/20 text-white rounded-full"
        >
          {flash ? <Zap /> : <ZapOff />}
        </button>
      </div>
    </div>
  );
}
